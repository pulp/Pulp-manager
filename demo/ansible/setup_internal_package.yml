---
# Optional playbook to upload demo package to int-demo-packages repository
# Run this after the main playbook completes and repo registration has created the repos

- name: Setup Internal Demo Package
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    project_dir: "{{ playbook_dir }}/../.."
    package_file: "{{ playbook_dir }}/../../demo/assets/packages/hello_2.10-2_amd64.deb"
    pulp_primary:
      name: "primary"
      url: "http://localhost:8000"
      container: "demo-pulp-primary-1"

  tasks:
    - name: Check if int-demo-packages repository exists
      shell: docker exec {{ pulp_primary.container }} pulp deb repository show --name 'int-demo-packages'
      register: repo_check
      failed_when: false

    - name: Fail if repository doesn't exist
      fail:
        msg: "Repository int-demo-packages does not exist. Run the main playbook first to create repos."
      when: repo_check.rc != 0

    - name: Upload package content to int-demo-packages
      shell: |
        docker cp {{ package_file }} {{ pulp_primary.container }}:/tmp/package.deb
        docker exec {{ pulp_primary.container }} bash -c "
          # Check if repo already has content
          has_content=\$(pulp deb repository show --name 'int-demo-packages' | grep 'latest_version_href' | grep -v '/versions/0/')
          if [ -z \"\$has_content\" ]; then
            pulp deb content upload --file /tmp/package.deb --repository 'int-demo-packages'
            echo 'Package uploaded'
          else
            echo 'Repository already has content, skipping upload'
          fi
          rm -f /tmp/package.deb
        "
      register: upload_result

    - name: Display upload result
      debug:
        msg: "{{ upload_result.stdout_lines }}"

    - name: Create publication and distribution for int-demo-packages
      shell: |
        docker exec {{ pulp_primary.container }} bash -c "
          # Create publication
          pulp deb publication create --repository 'int-demo-packages' --simple

          # Get latest publication href
          pub_href=\$(pulp deb publication list --repository 'int-demo-packages' --limit 1 | grep 'Pulp href' | awk '{print \$3}')

          # Update distribution to point to publication
          if pulp deb distribution show --name 'int-demo-packages' 2>/dev/null; then
            pulp deb distribution update --name 'int-demo-packages' --publication \"\$pub_href\"
            echo 'Distribution updated with new publication'
          else
            echo 'ERROR: Distribution int-demo-packages does not exist'
            exit 1
          fi
        "
      register: publish_result

    - name: Display publish result
      debug:
        msg: "{{ publish_result.stdout_lines }}"

    - name: Display completion message
      debug:
        msg:
          - ""
          - "============================================"
          - "Internal Package Setup Complete!"
          - "============================================"
          - ""
          - "Repository: int-demo-packages"
          - "Content: hello_2.10-2_amd64.deb"
          - ""
          - "You can now sync secondary server or test the repository."
          - ""
