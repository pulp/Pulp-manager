---
# Tasks to setup demo repositories on a Pulp server
# Variables required:
#   - pulp_server: dict with name, url, container
#   - repos: list of repository configs

- name: Create remotes on {{ pulp_server.name }}
  shell: |
    docker exec {{ pulp_server.container }} bash -c "
      pulp deb remote show --name '{{ item.remote.name }}' 2>/dev/null || \
      pulp deb remote create \
        --name '{{ item.remote.name }}' \
        --url '{{ item.remote.url }}' \
        --distribution '{{ item.remote.distribution }}' \
        {% if item.remote.component is defined %}--component '{{ item.remote.component }}'{% endif %} \
        {% if item.remote.architecture is defined %}--architecture '{{ item.remote.architecture }}'{% endif %}
    "
  loop: "{{ repos | selectattr('remote', 'defined') | selectattr('remote', 'ne', None) | list }}"
  loop_control:
    label: "{{ item.remote.name }}"

- name: Create repositories on {{ pulp_server.name }}
  shell: |
    docker exec {{ pulp_server.container }} bash -c "
      pulp deb repository show --name '{{ item.name }}' 2>/dev/null || \
      pulp deb repository create \
        --name '{{ item.name }}' \
        {% if item.remote is defined and item.remote %}--remote '{{ item.remote.name }}'{% endif %} \
        --description '{{ item.description }}'
    "
  loop: "{{ repos }}"
  loop_control:
    label: "{{ item.name }}"

- name: Upload package content on {{ pulp_server.name }}
  shell: |
    docker cp {{ item.package_file }} {{ pulp_server.container }}:/tmp/package.deb
    docker exec {{ pulp_server.container }} bash -c "
      # Check if repo already has content
      has_content=\$(pulp deb repository show --name '{{ item.name }}' | grep 'latest_version_href' | grep -v '/versions/0/')
      if [ -z \"\$has_content\" ]; then
        pulp deb content upload --file /tmp/package.deb --repository '{{ item.name }}'
      fi
      rm -f /tmp/package.deb
    "
  loop: "{{ repos | selectattr('package_file', 'defined') | list }}"
  loop_control:
    label: "{{ item.name }}"

- name: Create publications and distributions on {{ pulp_server.name }}
  shell: |
    docker exec {{ pulp_server.container }} bash -c "
      # Create publication
      pulp deb publication create --repository '{{ item.name }}' --simple

      # Get latest publication href
      pub_href=\$(pulp deb publication list --repository '{{ item.name }}' --limit 1 | grep 'Pulp href' | awk '{print \$3}')

      # Create or update distribution
      if pulp deb distribution show --name '{{ item.name }}' 2>/dev/null; then
        pulp deb distribution update --name '{{ item.name }}' --publication \"\$pub_href\"
      else
        pulp deb distribution create --name '{{ item.name }}' --base-path '{{ item.name }}' --publication \"\$pub_href\"
      fi
    "
  loop: "{{ repos | selectattr('publish', 'defined') | selectattr('publish', 'eq', true) | list }}"
  loop_control:
    label: "{{ item.name }}"
