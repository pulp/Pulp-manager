---
# Ansible playbook to set up Pulp Manager and Pulp Server demo environment

- name: Setup Pulp Manager Demo Environment
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    pulp_manager_url: "http://localhost:8080"
    pulp_username: "admin"
    pulp_password: "password"
    project_dir: "{{ playbook_dir }}/../.."
    package_file: "{{ playbook_dir }}/../../demo/assets/packages/hello_2.10-2_amd64.deb"
    pulp_primary:
      name: "primary"
      url: "http://localhost:8000"
      container: "demo-pulp-primary-1"
    pulp_secondary:
      name: "secondary"
      url: "http://localhost:8001"
      container: "demo-pulp-secondary-1"
    pulp_servers:
      - "{{ pulp_primary }}"
      - "{{ pulp_secondary }}"

    # Repository configurations for primary server
    primary_repos:
      - name: int-demo-packages
        description: "Internal demo repository base_url: int-demo-packages"
        package_file: "{{ package_file }}"
        publish: true
      - name: ext-demo-packages
        description: "External demo packages from nginx.org"
        remote:
          name: ext-demo-packages
          url: "http://nginx.org/packages/debian/"
          distribution: "bookworm"
          component: "nginx"
          architecture: "amd64"

    # Repository configurations for secondary server
    secondary_repos:
      - name: int-demo-packages
        description: "Internal demo repository synced from primary"
        remote:
          name: int-demo-packages
          url: "http://pulp-primary/pulp/content/int-demo-packages/"
          distribution: "/"
      - name: ext-demo-packages
        description: "External demo packages synced from primary server"
        remote:
          name: ext-demo-packages
          url: "http://pulp-primary/pulp/content/ext-demo-packages/"
          distribution: "bookworm"
          component: "nginx"
          architecture: "amd64"

  tasks:
    - name: Setup Docker network
      shell: docker network inspect pulp-net >/dev/null 2>&1 || docker network create pulp-net

    - name: Create key directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
      loop:
        - "{{ project_dir }}/demo/assets/certs"
        - "{{ project_dir }}/demo/assets/keys/gpg"
        - "{{ project_dir }}/demo/assets/nginx-conf"

    - name: Check if database encryption key exists
      stat:
        path: "{{ project_dir }}/demo/assets/certs/database_fields.symmetric.key"
      register: db_key_stat

    - name: Generate database encryption key
      shell: openssl rand -base64 32 > "{{ project_dir }}/demo/assets/certs/database_fields.symmetric.key"
      when: not db_key_stat.stat.exists

    - name: Check if GPG public key exists
      stat:
        path: "{{ project_dir }}/demo/assets/keys/gpg/public.key"
      register: gpg_key_stat

    - name: Check if GPG public key is empty
      stat:
        path: "{{ project_dir }}/demo/assets/keys/gpg/public.key"
      register: gpg_key_size
      when: gpg_key_stat.stat.exists

    - name: Clean GPG directory if key is missing or empty
      file:
        path: "{{ project_dir }}/demo/assets/keys/gpg"
        state: absent
      when: not gpg_key_stat.stat.exists or (gpg_key_stat.stat.exists and gpg_key_size.stat.size == 0)

    - name: Recreate GPG directory
      file:
        path: "{{ project_dir }}/demo/assets/keys/gpg"
        state: directory
        mode: '0700'
      when: not gpg_key_stat.stat.exists or (gpg_key_stat.stat.exists and gpg_key_size.stat.size == 0)

    - name: Generate GPG signing keys
      shell: |
        cat > /tmp/gpg-batch-config <<EOF
        Key-Type: RSA
        Key-Length: 2048
        Name-Real: Demo Signing Service
        Name-Email: signing@pulp-demo.local
        Expire-Date: 0
        %no-protection
        %commit
        EOF
        GNUPGHOME={{ project_dir }}/demo/assets/keys/gpg gpg-agent --daemon 2>/dev/null || true
        GNUPGHOME={{ project_dir }}/demo/assets/keys/gpg gpg --batch --no-default-keyring --keyring {{ project_dir }}/demo/assets/keys/gpg/pubring.kbx --gen-key /tmp/gpg-batch-config
        GNUPGHOME={{ project_dir }}/demo/assets/keys/gpg gpg --no-default-keyring --keyring {{ project_dir }}/demo/assets/keys/gpg/pubring.kbx --armor --export > {{ project_dir }}/demo/assets/keys/gpg/public.key
        GNUPGHOME={{ project_dir }}/demo/assets/keys/gpg gpgconf --kill gpg-agent 2>/dev/null || true
        rm /tmp/gpg-batch-config
      when: not gpg_key_stat.stat.exists or (gpg_key_stat.stat.exists and gpg_key_size.stat.size == 0)

    - name: Start Docker Compose cluster
      shell: docker compose -f demo/docker-compose.yml up -d --build
      args:
        chdir: "{{ project_dir }}"

    - name: Wait for Pulp servers to be ready
      uri:
        url: "{{ item.url }}/pulp/api/v3/status/"
        method: GET
        force_basic_auth: true
        url_username: "{{ pulp_username }}"
        url_password: "{{ pulp_password }}"
        status_code: [200]
      register: server_status
      until: server_status is not failed
      retries: 60
      delay: 5
      loop: "{{ pulp_servers }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Install pulp-cli in Pulp containers
      shell: |
        docker exec {{ item.container }} bash -c "pip install --quiet pulp-cli pulp-cli-deb"
      loop: "{{ pulp_servers }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Configure pulp-cli in containers
      shell: |
        docker exec {{ item.container }} bash -c "
          mkdir -p /root/.config/pulp
          cat > /root/.config/pulp/settings.toml <<EOF
        [cli]
        base_url = \"http://localhost\"
        username = \"{{ pulp_username }}\"
        password = \"{{ pulp_password }}\"
        verify_ssl = false
        EOF
        "
      loop: "{{ pulp_servers }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Register signing service on all servers
      shell: |
        docker exec {{ item.container }} sh -c '
          existing=$(pulpcore-manager shell -c "from pulpcore.app.models import SigningService; print(SigningService.objects.filter(name=\"deb_signing_service\").exists())" 2>/dev/null)
          if [ "$existing" != "True" ]; then
            key_id=$(GNUPGHOME=/opt/gpg gpg --list-secret-keys --with-colons 2>/dev/null | grep "^sec:" | cut -d: -f5 | head -1)
            if [ -n "$key_id" ]; then
              pulpcore-manager add-signing-service deb_signing_service /opt/scripts/deb_sign.sh "$key_id" --gnupghome /opt/gpg 2>/dev/null
              echo "Signing service created on {{ item.name }}"
            fi
          else
            echo "Signing service already exists on {{ item.name }}"
          fi
        '
      loop: "{{ pulp_servers }}"
      loop_control:
        label: "{{ item.name }}"

    # Setup repositories on primary server
    - name: Setup repositories on primary
      include_tasks: setup_demo_repos.yml
      vars:
        pulp_server: "{{ pulp_primary }}"
        repos: "{{ primary_repos }}"

    # Setup repositories on secondary server
    - name: Setup repositories on secondary
      include_tasks: setup_demo_repos.yml
      vars:
        pulp_server: "{{ pulp_secondary }}"
        repos: "{{ secondary_repos }}"

    - name: Trigger repository discovery on primary server
      uri:
        url: "{{ pulp_manager_url }}/v1/pulp_servers/1/sync_repos"
        method: POST
        body_format: json
        body:
          max_runtime: "3600"
          max_concurrent_syncs: 5
        status_code: [200, 201]
      register: primary_sync

    - name: Wait for primary server repository discovery
      uri:
        url: "{{ pulp_manager_url }}/v1/tasks/{{ primary_sync.json.id }}"
        method: GET
      register: primary_sync_task
      until: primary_sync_task.json.state in ["completed", "failed"]
      retries: 120
      delay: 5

    - name: Trigger repository discovery on secondary server
      uri:
        url: "{{ pulp_manager_url }}/v1/pulp_servers/2/sync_repos"
        method: POST
        body_format: json
        body:
          max_runtime: "3600"
          max_concurrent_syncs: 5
        status_code: [200, 201]
      register: secondary_sync

    - name: Wait for secondary server repository discovery
      uri:
        url: "{{ pulp_manager_url }}/v1/tasks/{{ secondary_sync.json.id }}"
        method: GET
      register: secondary_sync_task
      until: secondary_sync_task.json.state in ["completed", "failed"]
      retries: 120
      delay: 5

    - name: Display completion message
      debug:
        msg:
          - ""
          - "============================================"
          - "Demo Setup Complete!"
          - "============================================"
          - ""
          - "Pulp Manager API: {{ pulp_manager_url }}"
          - "RQ Dashboard: http://localhost:9181"
          - ""
          - "See README.md for usage examples."
          - ""
